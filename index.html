<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>âš”ï¸ ××œ×—××ª ×”×’'×•×§×¨×™×</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;700;800;900&family=Secular+One&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
<style>
:root {
  --crim:#DC2626; --ember:#F97316; --gold:#F59E0B; --emer:#10B981; --sky:#0EA5E9;
  --indo:#6366F1; --vio:#8B5CF6; --rose:#EC4899;
  --bg1:#0C0A1A; --bg2:#161230; --bg3:#1E1848; --bg4:#251F5A;
  --t1:#F1EEFF; --t2:#9B93C9; --t3:#6B619E; --brd:rgba(255,255,255,.06);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Rubik',sans-serif;background:var(--bg1);color:var(--t1);
  background-image:radial-gradient(ellipse at 15% 80%,rgba(99,102,241,.08),transparent 50%),
  radial-gradient(ellipse at 85% 20%,rgba(236,72,153,.06),transparent 50%)}
button{font-family:'Rubik',sans-serif;cursor:pointer;border:none;outline:none}
.H{display:none!important}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--vio);border-radius:3px}

/* Screens */
.S{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.S.A{display:flex}

/* Logo */
.logo{font-family:'Secular One',sans-serif;font-size:clamp(2.2rem,7vw,4rem);text-align:center;
  background:linear-gradient(135deg,var(--crim),var(--gold),var(--emer),var(--sky));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  filter:drop-shadow(0 0 30px rgba(99,102,241,.3));animation:fl 4s ease-in-out infinite;margin-bottom:5px}
@keyframes fl{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.tag{color:var(--t2);font-size:1rem;margin-bottom:25px;text-align:center}

/* Cards */
.mc{background:var(--bg2);border:1px solid var(--brd);border-radius:20px;padding:22px;width:min(420px,92vw);margin-bottom:12px}
.mc h3{font-size:1rem;color:var(--rose);margin-bottom:12px}
.mbs{display:flex;gap:10px;margin-bottom:10px}
.mb{flex:1;padding:14px 10px;border-radius:14px;background:rgba(255,255,255,.04);border:2px solid var(--brd);color:var(--t1);font-weight:600;font-size:.9rem;transition:all .25s;text-align:center}
.mb.X{background:var(--indo);border-color:var(--indo);box-shadow:0 0 25px rgba(99,102,241,.35)}
.nr{display:flex;align-items:center;gap:10px;margin:8px 0}
.nd{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;color:#fff;flex-shrink:0;font-weight:700}
.ni{flex:1;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid var(--brd);color:var(--t1);font-family:'Rubik',sans-serif;font-size:.95rem}
.ni:focus{border-color:var(--indo);outline:none}
.ni::placeholder{color:var(--t3)}
.rcd{font-family:'Secular One',monospace;font-size:2rem;letter-spacing:6px;text-align:center;color:var(--gold);padding:10px;background:rgba(245,158,11,.08);border-radius:12px;margin:8px 0;border:1px dashed rgba(245,158,11,.3);user-select:all}
.rir{display:flex;gap:8px}
.rin{flex:1;padding:12px;border-radius:12px;text-align:center;background:rgba(255,255,255,.06);border:1px solid var(--brd);color:var(--t1);font-family:'Secular One',monospace;font-size:1.5rem;letter-spacing:4px}
.rin:focus{border-color:var(--gold);outline:none}
.bp{width:100%;padding:15px;border-radius:50px;background:linear-gradient(135deg,var(--indo),var(--vio));color:#fff;font-weight:700;font-size:1.1rem;transition:all .3s;margin-top:8px;box-shadow:0 4px 20px rgba(99,102,241,.3)}
.bp:hover{transform:translateY(-2px)}
.st{text-align:center;color:var(--t2);font-size:.85rem;margin-top:8px}
.st.E{color:var(--crim)}.st.G{color:var(--emer)}

/* Draft */
#draft{justify-content:flex-start;padding-top:15px}
.dh{text-align:center;margin-bottom:8px}
.dh h2{font-family:'Secular One',sans-serif;font-size:1.4rem;margin-bottom:4px}
.dt{color:var(--gold);font-weight:600;font-size:1rem}
.di{color:var(--t2);font-size:.85rem;margin-top:4px}
.dp{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;width:min(600px,95vw);margin:8px 0;max-height:52vh;overflow-y:auto;padding:4px}
.jc{background:var(--bg3);border:2px solid var(--brd);border-radius:14px;padding:10px;cursor:pointer;transition:all .25s;position:relative}
.jc:hover{border-color:var(--indo);transform:translateY(-3px)}
.jc.SL{border-color:var(--gold);box-shadow:0 0 20px rgba(245,158,11,.3)}
.jc.TK{opacity:.3;pointer-events:none}
.ji{font-size:1.7rem;text-align:center;margin-bottom:3px}
.jn{font-weight:700;font-size:.78rem;text-align:center;margin-bottom:3px}
.jd{font-size:.62rem;color:var(--t2);text-align:center;line-height:1.4}
.jr{position:absolute;top:5px;left:5px;font-size:.52rem;padding:2px 5px;border-radius:5px;font-weight:600}
.jr.c{background:rgba(16,185,129,.2);color:var(--emer)}
.jr.r{background:rgba(14,165,233,.2);color:var(--sky)}
.jr.l{background:rgba(245,158,11,.2);color:var(--gold)}
.jr.e{background:rgba(236,72,153,.2);color:var(--rose)}
.dps{display:flex;gap:8px;justify-content:center;margin:6px 0}
.dsl{width:48px;height:48px;border-radius:12px;border:2px dashed var(--brd);display:flex;align-items:center;justify-content:center;font-size:1.4rem;background:var(--bg2)}
.dsl.F{border-style:solid;border-color:var(--gold)}
.bc{padding:12px 40px;border-radius:50px;background:linear-gradient(135deg,var(--gold),var(--ember));color:#1a1a2e;font-weight:700;font-size:1rem;transition:all .3s;margin-top:5px}
.bc:disabled{opacity:.35;cursor:not-allowed}

/* Hot seat transition */
.tov{position:fixed;inset:0;z-index:500;background:rgba(12,10,26,.97);backdrop-filter:blur(10px);display:none;flex-direction:column;align-items:center;justify-content:center;gap:15px}
.tov.A{display:flex}
.tov h2{font-family:'Secular One',sans-serif;font-size:1.8rem}
.tn{font-size:1.4rem;font-weight:700}
.th{color:var(--t2);font-size:.9rem;text-align:center;max-width:300px}
.brev{padding:14px 40px;border-radius:50px;background:linear-gradient(135deg,var(--emer),#059669);color:#fff;font-weight:700;font-size:1.1rem;transition:all .2s;margin-top:10px}
.brev:hover{transform:scale(1.05)}

/* Game screen */
#game{padding:8px;justify-content:space-between;gap:5px}
.gt{width:100%;display:flex;justify-content:space-between;align-items:center;background:var(--bg2);border-radius:14px;padding:8px 14px}
.pb{display:flex;align-items:center;gap:8px}
.sa{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;color:#fff;font-weight:700}
.si{font-size:.8rem}.si .sn{font-weight:600}.si .sw{color:var(--gold);font-weight:700}
.sv{font-family:'Secular One',sans-serif;color:var(--t3);font-size:.9rem}
.rinfo{text-align:center;font-size:.75rem;color:var(--t2)}
.jbar{width:100%;display:flex;justify-content:center;gap:5px;flex-wrap:wrap}
.mj{background:var(--bg3);border-radius:10px;padding:3px 7px;font-size:.68rem;display:flex;align-items:center;gap:3px;border:1px solid var(--brd)}
.mj.U{opacity:.3;text-decoration:line-through}

.barea{flex:1;display:flex;align-items:center;justify-content:center;gap:25px;width:100%;min-height:0}
.bslot{width:100px;height:145px;border-radius:16px;border:2px dashed var(--brd);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .3s;position:relative}
.bslot.F{border:none}
.bslot .lb{font-size:.7rem;color:var(--t3);position:absolute;bottom:-18px}
.vsym{font-family:'Secular One',sans-serif;font-size:1.5rem;color:var(--t3);flex-shrink:0}

/* Playing cards */
.card{width:100px;height:145px;border-radius:16px;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;transition:all .25s;cursor:pointer;border:2px solid rgba(255,255,255,.12);box-shadow:0 4px 15px rgba(0,0,0,.3)}
.card:hover{transform:translateY(-8px) scale(1.02);z-index:10}
.card.SEL{border-color:var(--gold)!important;box-shadow:0 0 25px rgba(245,158,11,.5);transform:translateY(-12px)}
.card.SEL2{border-color:var(--emer)!important;box-shadow:0 0 25px rgba(16,185,129,.5);transform:translateY(-12px)}
.cval{font-size:2rem}
.csT{position:absolute;top:6px;right:8px;font-size:.9rem}
.csB{position:absolute;bottom:6px;left:8px;font-size:.9rem}
.cbon{position:absolute;top:-8px;left:-8px;background:var(--gold);color:#1a1a2e;font-size:.65rem;font-weight:800;padding:2px 6px;border-radius:8px;box-shadow:0 2px 8px rgba(245,158,11,.4)}
.clbl{font-size:.6rem;margin-top:2px}
.c-h{background:linear-gradient(145deg,#7f1d1d,#991b1b)}
.c-d{background:linear-gradient(145deg,#78350f,#92400e)}
.c-s{background:linear-gradient(145deg,#312e81,#3730a3)}
.c-c{background:linear-gradient(145deg,#064e3b,#065f46)}
.c-fi{background:linear-gradient(145deg,#991b1b,#dc2626)}
.c-wa{background:linear-gradient(145deg,#1e3a5f,#2563eb)}
.c-ic{background:linear-gradient(145deg,#164e63,#0891b2)}
.c-wi{background:linear-gradient(145deg,#365314,#65a30d)}
.cback{width:100px;height:145px;border-radius:16px;background:linear-gradient(135deg,var(--bg4),var(--bg3));border:2px solid var(--brd);display:flex;align-items:center;justify-content:center}
.cback::after{content:'ğŸƒ';font-size:2.5rem;opacity:.3}

.hsec{width:100%}
.hlbl{font-size:.75rem;color:var(--t3);text-align:center;margin-bottom:4px}
.hcards{display:flex;gap:7px;justify-content:center;padding:5px 10px;flex-wrap:wrap}
.hcards .card{width:75px;height:110px}
.hcards .card .cval{font-size:1.5rem}
.hcards .card .csT{font-size:.7rem;top:4px;right:5px}
.hcards .card .csB{font-size:.7rem;bottom:4px;left:5px}

.gacts{display:flex;gap:8px;justify-content:center;width:100%;flex-wrap:wrap}
.gbtn{padding:10px 20px;border-radius:12px;font-weight:700;font-size:.85rem;transition:all .2s;display:flex;align-items:center;gap:5px}
.gplay{background:linear-gradient(135deg,var(--indo),var(--vio));color:#fff}
.gplay:disabled{opacity:.3;cursor:not-allowed}

/* Overlays */
.ov{position:fixed;inset:0;z-index:400;background:rgba(12,10,26,.92);backdrop-filter:blur(8px);display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px}
.ov.A{display:flex}
.ovH{font-family:'Secular One',sans-serif;font-size:1.8rem;margin-top:5px}
.ovD{color:var(--t2);font-size:.85rem;text-align:center;max-width:350px;line-height:1.5}
.ovCards{display:flex;align-items:center;gap:20px;margin:10px 0}
.ovWrap{text-align:center}
.ovWrap .wn{font-size:.85rem;margin-bottom:5px;font-weight:600}
.ovWrap .wv{font-size:.8rem;color:var(--t2);margin-top:5px}
.ovVs{font-family:'Secular One',sans-serif;font-size:1.3rem;color:var(--t3)}
.bcont{padding:12px 35px;border-radius:50px;background:var(--indo);color:#fff;font-weight:700;font-size:.95rem;transition:all .2s;margin-top:5px}

/* Ace modal */
.ace{position:fixed;inset:0;z-index:600;background:rgba(12,10,26,.95);display:none;flex-direction:column;align-items:center;justify-content:center;gap:15px}
.ace.A{display:flex}
.ace h3{font-family:'Secular One',sans-serif;font-size:1.3rem}
.aceOpts{display:flex;gap:15px}
.aceBtn{padding:18px 30px;border-radius:16px;background:var(--bg3);border:2px solid var(--brd);color:var(--t1);font-size:1.5rem;font-weight:800;transition:all .2s}
.aceBtn:hover{border-color:var(--gold);transform:scale(1.1)}

/* Game over */
#gover{gap:20px}
.goT{font-family:'Secular One',sans-serif;font-size:clamp(2rem,6vw,3rem)}
.goW{font-size:1.5rem;font-weight:700}
.goS{color:var(--t2);font-size:1.1rem}
.cfbox{position:fixed;inset:0;pointer-events:none;z-index:300;overflow:hidden}
.cfp{position:absolute;top:-10px;animation:cfa linear forwards}
@keyframes cfa{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}

/* Announce */
.ann{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(0,0,0,.9);border:2px solid var(--indo);color:#fff;padding:16px 35px;border-radius:18px;font-weight:700;font-size:1.15rem;z-index:450;pointer-events:none;text-align:center;font-family:'Secular One',sans-serif;white-space:nowrap}
.ann.SH{animation:anI .35s ease-out forwards,anO .35s ease-in 1.4s forwards}
@keyframes anI{0%{transform:translate(-50%,-50%) scale(0)}100%{transform:translate(-50%,-50%) scale(1)}}
@keyframes anO{0%{transform:translate(-50%,-50%) scale(1);opacity:1}100%{transform:translate(-50%,-50%) scale(.5);opacity:0}}

.rfloat{position:fixed;top:10px;left:10px;z-index:100;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.08);color:var(--t1);font-size:1rem;display:flex;align-items:center;justify-content:center}
.mov{position:fixed;inset:0;z-index:700;background:rgba(12,10,26,.95);display:none;align-items:center;justify-content:center;padding:20px}
.mov.A{display:flex}
.mbox{background:var(--bg2);border-radius:20px;padding:25px;max-width:500px;width:100%;max-height:85vh;overflow-y:auto;border:1px solid var(--brd)}
.mbox h2{font-family:'Secular One',sans-serif;font-size:1.3rem;margin-bottom:12px;text-align:center}
.mbox h3{color:var(--rose);font-size:.95rem;margin:12px 0 6px}
.mbox p{font-size:.85rem;line-height:1.6;color:var(--t2)}
.ruleI{background:rgba(255,255,255,.03);border-radius:10px;padding:8px 12px;margin:5px 0;border-right:3px solid var(--vio);font-size:.8rem;line-height:1.5}
.bcls{margin-top:15px;padding:10px 25px;border-radius:12px;background:var(--vio);color:#fff;font-weight:600;display:block;margin-left:auto;margin-right:auto}

.pairHint{text-align:center;font-size:.75rem;color:var(--gold);margin-bottom:4px;min-height:1em}

@media(max-width:450px){
  .card{width:85px;height:122px}.card .cval{font-size:1.7rem}
  .hcards .card{width:60px;height:88px}.hcards .card .cval{font-size:1.2rem}
  .barea{gap:12px}.dp{grid-template-columns:repeat(auto-fill,minmax(115px,1fr))}
}
</style>
</head>
<body>

<button class="rfloat" onclick="toggleRules()">â“</button>
<div class="ann H" id="ann"></div>

<!-- Rules -->
<div class="mov" id="rulesM">
<div class="mbox">
<h2>ğŸ“– ×—×•×§×™ ××œ×—××ª ×”×’'×•×§×¨×™×</h2>
<h3>ğŸ¯ ××˜×¨×”</h3><p>×œ× ×¦×— ×‘×™×•×ª×¨ ×¡×™×‘×•×‘×™ ×§×¨×‘!</p>
<h3>ğŸ“‹ ××”×œ×š</h3>
<div class="ruleI">×›×œ ×©×—×§×Ÿ ××ª×—×™×œ ×¢× 5 ×§×œ×¤×™×. ×›×œ ×¡×™×‘×•×‘ ×‘×•×—×¨×™× ×§×œ×£ â€” ×”×’×‘×•×” ×× ×¦×—. ××—×¨×™ ×›×œ ×¡×™×‘×•×‘ ××©×œ×™××™× ×œ-5.</div>
<div class="ruleI">×›×©×”×—×¤×™×¡×” × ×’××¨×ª, ××©×—×§×™× ×¢× ××” ×©× ×©××¨. ××™ ×©× ×™×¦×— ×‘×™×•×ª×¨ ×¡×™×‘×•×‘×™× ×× ×¦×—!</div>
<h3>ğŸƒ ××¡ (A)</h3><div class="ruleI">××¡ = 1 ××• 14 ×œ×‘×—×™×¨×ª×š!</div>
<h3>ğŸ‘¥ ×–×•×’×•×ª</h3><div class="ruleI">×¤×©×•×˜ ×‘×—×¨ ×©× ×™ ×§×œ×¤×™× ×¢× ××•×ª×• ××¡×¤×¨ â€” ×”×¢×¨×š = ×¡×›×•× ×©× ×™×”×!</div>
<h3>ğŸ”¥ ××œ×× ×˜×™×</h3>
<div class="ruleI">×¢×¨×š 7. ××©ğŸ”¥>×§×¨×—â„ï¸>×¨×•×—ğŸŒªï¸>××™×ğŸ’§>××©ğŸ”¥. ×× ×¦×—=12, ××¤×¡×™×“=2.</div>
<div class="ruleI">ğŸ”¥ ×™×¨×™×‘ ×××‘×“ ×§×œ×£ | ğŸ’§ ×©×•×œ×£ ×§×œ×£ | â„ï¸ ×™×¨×™×‘ ×‘×¢×™×•×•×¨ | ğŸŒªï¸ ×™×¨×™×‘ ××—×œ×™×£ ×§×œ×£</div>
<h3>ğŸƒ ×’'×•×§×¨×™×</h3><div class="ruleI">×“×¨××¤×˜: 10 ××•×’×¨×œ×™×, ×›×œ ××—×“ ×‘×•×—×¨ 3 ×‘×ª×•×¨×•×ª!</div>
<button class="bcls" onclick="toggleRules()">×¡×’×•×¨ âœ–</button>
</div></div>

<!-- Menu -->
<div class="S A" id="menu">
<div class="logo">âš”ï¸ ××œ×—××ª ×”×’'×•×§×¨×™×</div>
<div class="tag">××©×—×§ ×§×œ×¤×™× ××¡×˜×¨×˜×’×™</div>
<div class="mc"><h3>ğŸ® ××¦×‘ ××©×—×§</h3>
<div class="mbs">
<button class="mb X" id="mLocal" onclick="setMode('local')">ğŸ“± ××›×©×™×¨ ××—×“</button>
<button class="mb" id="mOnline" onclick="setMode('online')">ğŸŒ ××•× ×œ×™×™×Ÿ</button>
</div></div>

<div class="mc" id="localCard"><h3>ğŸ‘¤ ×©××•×ª ×©×—×§× ×™×</h3>
<div class="nr"><div class="nd" style="background:var(--crim)">1</div><input class="ni" id="inp1" placeholder="×©×—×§×Ÿ 1" maxlength="12"></div>
<div class="nr"><div class="nd" style="background:var(--sky)">2</div><input class="ni" id="inp2" placeholder="×©×—×§×Ÿ 2" maxlength="12"></div>
<button class="bp" onclick="startLocal()">âš”ï¸ ×”×ª×—×œ!</button>
</div>

<div class="mc H" id="onlineCard"><h3>ğŸŒ ××•× ×œ×™×™×Ÿ</h3>
<div class="nr"><div class="nd" style="background:var(--emer)">ğŸ‘¤</div><input class="ni" id="inpOn" placeholder="×”×©× ×©×œ×š" maxlength="12"></div>
<div class="mbs" style="margin-top:10px">
<button class="mb X" id="rHost" onclick="setRole('host')">ğŸ  ×¦×•×¨ ×—×“×¨</button>
<button class="mb" id="rJoin" onclick="setRole('join')">ğŸšª ×”×¦×˜×¨×£</button>
</div>
<div id="secHost">
<button class="bp" onclick="createRoom()">âœ¨ ×¦×•×¨ ×—×“×¨</button>
<div id="hostCreated" class="H">
<div class="rcd" id="roomCodeShow"></div>
<div class="st">×©×ª×£ ××ª ×”×§×•×“!</div><div class="st" id="hostSt"></div>
</div></div>
<div id="secJoin" class="H">
<div class="rir"><input class="rin" id="roomCodeIn" placeholder="×§×•×“" maxlength="6">
<button class="bp" style="width:auto;padding:12px 20px" onclick="joinRoom()">ğŸš€</button></div>
<div class="st" id="joinSt"></div>
</div></div>
</div>

<!-- Draft -->
<div class="S" id="draft">
<div class="dh"><h2>ğŸƒ ×“×¨××¤×˜ ×’'×•×§×¨×™×</h2><div class="dt" id="dTurn"></div><div class="di">×‘×—×¨ ×’'×•×§×¨ ××—×“</div></div>
<div class="dps" id="dPicks"></div>
<div class="dp" id="dPool"></div>
<button class="bc" id="btnDraft" onclick="confirmDraft()" disabled>××©×¨ ×‘×—×™×¨×” âœ“</button>
</div>

<!-- Hot seat -->
<div class="tov" id="hotSeat">
<h2>ğŸ´ ×”×ª×•×¨ ×©×œ:</h2>
<div class="tn" id="hsName"></div>
<div class="th" id="hsHint"></div>
<button class="brev" onclick="doReveal()">ğŸ‘€ ××•×›×Ÿ â€” ×—×©×•×£ ×§×œ×¤×™×</button>
</div>

<!-- Game -->
<div class="S" id="game">
<div class="gt">
<div class="pb"><div class="sa" style="background:var(--crim)">1</div><div class="si"><div class="sn" id="gn1"></div><div class="sw" id="gw1">0 âœ“</div></div></div>
<div><div class="sv">VS</div><div class="rinfo" id="gRound"></div></div>
<div class="pb"><div class="si" style="text-align:left"><div class="sn" id="gn2"></div><div class="sw" id="gw2">0 âœ“</div></div><div class="sa" style="background:var(--sky)">2</div></div>
</div>
<div class="jbar" id="jBar"></div>
<div class="barea">
<div class="bslot" id="slot1"><span class="lb" id="slbl1"></span></div>
<div class="vsym">âš”ï¸</div>
<div class="bslot" id="slot2"><span class="lb" id="slbl2"></span></div>
</div>
<div class="gacts">
<button class="gbtn gplay" id="btnPlay" onclick="confirmPlay()" disabled>âš”ï¸ ×œ×—×™××”!</button>
</div>
<div class="hsec">
<div class="pairHint" id="pairHint"></div>
<div class="hlbl" id="handLbl">×”×™×“ ×©×œ×š</div>
<div class="hcards" id="handArea"></div>
</div>
</div>

<!-- Ace choice -->
<div class="ace" id="aceModal">
<h3>ğŸ´ ××¡ â€” ×‘×—×¨ ×¢×¨×š</h3>
<div class="aceOpts">
<button class="aceBtn" onclick="pickAce(1)">1<br><small>× ××•×š</small></button>
<button class="aceBtn" onclick="pickAce(14)">14<br><small>×’×‘×•×”</small></button>
</div></div>

<!-- Result -->
<div class="ov" id="resultOv">
<div class="ovH" id="resTxt"></div>
<div class="ovCards" id="resCards"></div>
<div class="ovD" id="resDetail"></div>
<button class="bcont" onclick="afterResult()">×”××©×š â–¶</button>
</div>

<!-- Spy -->
<div class="ov" id="spyOv" style="z-index:550">
<h3 style="font-family:'Secular One',sans-serif;font-size:1.3rem">ğŸ‘ï¸ ×¨×™×’×•×œ!</h3>
<p id="spyTxt" style="color:var(--t2)"></p>
<div id="spyCards" style="display:flex;gap:10px"></div>
<button class="bcont" onclick="Q('spyOv').classList.remove('A')">×”×‘× ×ª×™ ğŸ‘</button>
</div>

<!-- Game Over -->
<div class="S" id="gover">
<div class="cfbox" id="confetti"></div>
<div class="goT">ğŸ† ×¡×•×£ ×”××©×—×§! ğŸ†</div>
<div class="goW" id="goWin"></div>
<div class="goS" id="goScore"></div>
<button class="bp" style="width:min(350px,80vw);margin-top:10px" onclick="backToMenu()">ğŸ”„ ××©×—×§ ×—×“×©</button>
</div>

<script>
// ==================== HELPERS ====================
const Q = id => document.getElementById(id);

// ==================== JOKER DEFS ====================
const ALL_JOKERS = [
  {id:1,n:'×©×¨×™×•×Ÿ',ic:'ğŸ›¡ï¸',d:'×§×œ×¤×™× 1-4 ××§×‘×œ×™× +3',r:'common'},
  {id:2,n:'×›×ª×¨',ic:'ğŸ‘‘',d:'J/Q/K ××§×‘×œ×™× +2',r:'common'},
  {id:3,n:'×–×•×’×™',ic:'ğŸ²',d:'×§×œ×¤×™× ×–×•×’×™×™× +2',r:'common'},
  {id:4,n:'××™-×–×•×’×™',ic:'ğŸ¯',d:'××™-×–×•×’×™×™× +2',r:'common'},
  {id:5,n:'×‘×•×œ×“×•×–×¨',ic:'ğŸšœ',d:'10-K +1, ×”×¤×¨×© 5+ = ×™×¨×™×‘ ×××‘×“ ×§×œ×£',r:'common'},
  {id:6,n:'×¦×‘',ic:'ğŸ¢',d:'××—×¨×™ ×”×¤×¡×“, ×”×‘× +2',r:'common'},
  {id:7,n:'×××–× ×™×™×',ic:'âš–ï¸',d:'×ª×™×§×• = × ×™×¦×—×•×Ÿ',r:'common'},
  {id:8,n:'××’× ×˜',ic:'ğŸ§²',d:'â™¥ ×œ×‘ +3',r:'common'},
  {id:9,n:'×‘×¨×–×œ',ic:'âš”ï¸',d:'â™  ×¢×œ×” +3',r:'common'},
  {id:10,n:'××•×¨',ic:'ğŸ’',d:'â™¦ ×™×”×œ×•× +3',r:'common'},
  {id:11,n:'×ª×œ×ª×Ÿ',ic:'ğŸ€',d:'â™£ ×ª×œ×ª×Ÿ +3',r:'common'},
  {id:12,n:'××”×™×¨',ic:'âš¡',d:'×§×œ×£ ×¨××©×•×Ÿ +5',r:'common'},
  {id:13,n:'××¨×’×œ',ic:'ğŸ‘ï¸',d:'×¨×•××” ×§×œ×£ ×©×œ ×”×™×¨×™×‘',r:'rare'},
  {id:14,n:'× ×§××”',ic:'ğŸ”¥',d:'××—×¨×™ ×”×¤×¡×“ +4',r:'rare'},
  {id:15,n:'×¨×¦×£',ic:'ğŸ”—',d:'× ×™×¦×—×•× ×•×ª ×‘×¨×¦×£ +1/+2/+3',r:'rare'},
  {id:16,n:'×’× ×‘',ic:'ğŸ¤',d:'× ×™×¦×—×•×Ÿ = ×’×•× ×‘ ×§×œ×£',r:'rare'},
  {id:17,n:'×¢×¨×¤×œ',ic:'ğŸŒ«ï¸',d:'×™×¨×™×‘ ×œ× ×¨×•××” ××” ×©××ª',r:'rare'},
  {id:18,n:'××¨××”',ic:'ğŸª',d:'×¤×¢× ××—×ª â€” ××¢×ª×™×§ ×¢×¨×š +1',r:'rare',used:false},
  {id:19,n:'×©×¢×•×Ÿ ×—×•×œ',ic:'â³',d:'××•×ª×• ××¡×¤×¨ ×§×œ×¤×™× = +1',r:'rare'},
  {id:20,n:'×—×•××”',ic:'ğŸ§±',d:'×”×¤×¡×“ â€” 50% ×‘×™×˜×•×œ',r:'rare'},
  {id:21,n:'×¡×•×—×¨',ic:'ğŸ¤',d:'××—×œ×™×£ ×§×œ×£ ×‘×”×ª×—×œ×”',r:'rare'},
  {id:22,n:'××¡ ×‘×©×¨×•×•×œ',ic:'ğŸ©',d:'××¡×™× ×ª××™×“ = 14',r:'rare'},
  {id:23,n:'×¤× ×™×§×¡',ic:'ğŸ¦',d:'â‰¤2 ×§×œ×¤×™× = ×©×•×œ×£ 3 (×¤"×)',r:'legendary',used:false},
  {id:24,n:'××”×¤×š',ic:'ğŸ”„',d:'×¤"× â€” ×”×•×¤×š ×”×¤×¡×“',r:'legendary',used:false},
  {id:25,n:'××™× ×¤×™× ×™×˜×™',ic:'â™¾ï¸',d:'××›×¤×™×œ ×’\'×•×§×¨ ××—×¨',r:'legendary'},
  {id:26,n:'×›××•×¡',ic:'ğŸŒ€',d:'2 ×§×œ×¤×™× ××—×œ×™×¤×™× ×¢×¨×›×™×',r:'legendary'},
  {id:27,n:'×¦×œ',ic:'ğŸ‘¤',d:'××¢×ª×™×§ ×’\'×•×§×¨ ×™×¨×™×‘',r:'legendary'},
  {id:28,n:'×›×•×— ×¢×œ×™×•×Ÿ',ic:'ğŸ’«',d:'×”× ××•×š ×‘×™×•×ª×¨ = 15',r:'legendary'},
  {id:29,n:'×©×œ×™×˜×ª ×™×¡×•×“×•×ª',ic:'ğŸŒ',d:'××œ×× ×˜ +3, ××¤×§×˜ ×›×¤×•×œ',r:'element'},
  {id:30,n:'×¡×•×¤×”',ic:'ğŸŒŠ',d:'××œ×× ×˜ = ×©×•×œ×£ ×§×œ×£',r:'element'},
];

// ==================== CARD DEFS ====================
const SUITS = ['heart','diamond','spade','club'];
const SUIT_ICON = {heart:'â™¥',diamond:'â™¦',spade:'â™ ',club:'â™£'};
const SUIT_CLS = {heart:'c-h',diamond:'c-d',spade:'c-s',club:'c-c'};
const FACE_NAME = {1:'A',11:'J',12:'Q',13:'K'};
const ELEMS = ['fire','water','ice','wind'];
const ELEM_IC = {fire:'ğŸ”¥',water:'ğŸ’§',ice:'â„ï¸',wind:'ğŸŒªï¸'};
const ELEM_BEATS = {fire:'ice',ice:'wind',wind:'water',water:'fire'};
const ELEM_CLS = {fire:'c-fi',water:'c-wa',ice:'c-ic',wind:'c-wi'};
const ELEM_HEB = {fire:'××©',water:'××™×',ice:'×§×¨×—',wind:'×¨×•×—'};

function createDeck() {
  let deck = [], id = 0;
  for (let s of SUITS)
    for (let v = 1; v <= 13; v++)
      deck.push({id: id++, type: 'normal', suit: s, value: v});
  for (let e of ELEMS) {
    deck.push({id: id++, type: 'element', elem: e, value: 7});
    deck.push({id: id++, type: 'element', elem: e, value: 7});
  }
  return shuffle(deck);
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// ==================== GAME STATE ====================
let G = {};
let draftSel = null;     // selected joker id during draft
let sel1 = null;          // first card selected
let sel2 = null;          // second card selected (for pair)
let aceCb = null;         // ace choice callback
let hsCb = null;          // hot seat callback

// Multiplayer
let peer = null, conn = null, myIdx = -1;
let _hostName = '';

function isOnline() { return conn !== null && conn.open && myIdx >= 0; }

function initGame(n1, n2) {
  const deck = createDeck();
  G = {
    deck: deck,
    players: [
      {name: n1, hand: [], jokers: [], wins: 0, streak: 0, lastLost: false, blind: false, firstPlay: true},
      {name: n2, hand: [], jokers: [], wins: 0, streak: 0, lastLost: false, blind: false, firstPlay: true},
    ],
    round: 0,
    draftPool: [],
    draftRound: 0,
    currentDrafter: 0,
    picks: [null, null],  // each player's pick for this round
    turnPlayer: 0,
    spySeen: false,
  };
}

// ==================== SCREENS ====================
function showScreen(id) {
  document.querySelectorAll('.S').forEach(s => s.classList.remove('A'));
  Q(id).classList.add('A');
}

// ==================== MENU ====================
let gameMode = 'local';
let netRole = 'host';

function setMode(m) {
  gameMode = m;
  Q('mLocal').classList.toggle('X', m === 'local');
  Q('mOnline').classList.toggle('X', m === 'online');
  Q('localCard').classList.toggle('H', m === 'online');
  Q('onlineCard').classList.toggle('H', m === 'local');
}

function setRole(r) {
  netRole = r;
  Q('rHost').classList.toggle('X', r === 'host');
  Q('rJoin').classList.toggle('X', r === 'join');
  Q('secHost').classList.toggle('H', r !== 'host');
  Q('secJoin').classList.toggle('H', r !== 'join');
}

// ==================== LOCAL START ====================
function startLocal() {
  const n1 = Q('inp1').value.trim() || '×©×—×§×Ÿ 1';
  const n2 = Q('inp2').value.trim() || '×©×—×§×Ÿ 2';
  myIdx = -1; conn = null; peer = null;
  initGame(n1, n2);
  dealHands();
  setupDraft();
  showScreen('draft');
  showHotSeat(0, '×‘×—×¨ ×’\'×•×§×¨', () => renderDraft());
}

function dealHands() {
  for (let p of G.players) {
    p.hand = [];
    for (let i = 0; i < 5; i++) {
      if (G.deck.length > 0) p.hand.push(G.deck.pop());
    }
  }
}

// ==================== ONLINE (PeerJS) ====================
function genCode() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let r = '';
  for (let i = 0; i < 5; i++) r += c[Math.floor(Math.random() * c.length)];
  return r;
}

function createRoom() {
  _hostName = Q('inpOn').value.trim() || '×××¨×—';
  const code = genCode();
  const peerId = 'jokerwar-' + code;

  Q('hostSt').textContent = '××ª×—×‘×¨ ×œ×©×¨×ª...';
  Q('hostSt').className = 'st';
  Q('bcr')?.setAttribute('disabled', 'true');

  peer = new Peer(peerId, {debug: 0});

  peer.on('open', () => {
    Q('roomCodeShow').textContent = code;
    Q('hostCreated').classList.remove('H');
    Q('hostSt').textContent = '×××ª×™×Ÿ ×œ×©×—×§×Ÿ ×©× ×™...';
    Q('hostSt').className = 'st G';
  });

  peer.on('error', err => {
    Q('hostSt').textContent = err.type === 'unavailable-id' ? '×§×•×“ ×ª×¤×•×¡, ×¨×¢× ×Ÿ ×•× ×¡×” ×©×•×‘' : '×©×’×™××”: ' + err.type;
    Q('hostSt').className = 'st E';
  });

  peer.on('connection', c => {
    conn = c;
    myIdx = 0;
    conn.on('open', () => {
      Q('hostSt').textContent = '×©×—×§×Ÿ ××—×•×‘×¨!';
    });
    conn.on('data', d => onNetMsg(d));
  });
}

function joinRoom() {
  const name = Q('inpOn').value.trim() || '××•×¨×—';
  const code = Q('roomCodeIn').value.trim().toUpperCase();
  if (code.length < 4) { Q('joinSt').textContent = '×§×•×“ ×§×¦×¨ ××“×™'; Q('joinSt').className = 'st E'; return; }

  Q('joinSt').textContent = '××ª×—×‘×¨...';
  Q('joinSt').className = 'st';

  peer = new Peer(undefined, {debug: 0});
  peer.on('open', () => {
    conn = peer.connect('jokerwar-' + code, {reliable: true});
    conn.on('open', () => {
      Q('joinSt').textContent = '××—×•×‘×¨! âœ“';
      Q('joinSt').className = 'st G';
      myIdx = 1;
      conn.on('data', d => onNetMsg(d));
      send({type: 'join', name: name});
    });
    conn.on('error', () => {
      Q('joinSt').textContent = '×©×’×™××ª ×—×™×‘×•×¨';
      Q('joinSt').className = 'st E';
    });
  });
  peer.on('error', () => {
    Q('joinSt').textContent = '×—×“×¨ ×œ× × ××¦× âŒ';
    Q('joinSt').className = 'st E';
  });
}

function send(msg) {
  if (conn && conn.open) conn.send(msg);
}

function onNetMsg(d) {
  switch (d.type) {
    case 'join':
      // Host got guest name
      initGame(_hostName, d.name);
      dealHands();
      setupDraft();
      // Send full state
      send({type: 'init', G: JSON.parse(JSON.stringify(G))});
      showScreen('draft');
      renderDraft();
      break;

    case 'init':
      G = d.G;
      showScreen('draft');
      renderDraft();
      break;

    case 'draftPick':
      applyDraftPick(d.jokerId, d.by);
      break;

    case 'cardPick':
      G.picks[d.by] = d.pick;
      // Remove from their hand
      const p = G.players[d.by];
      if (d.pick.isPair) {
        p.hand = p.hand.filter(c => c.id !== d.pick.c1.id && c.id !== d.pick.c2.id);
      } else {
        p.hand = p.hand.filter(c => c.id !== d.pick.id);
      }
      if (G.picks[0] && G.picks[1]) resolveBattle();
      else renderGame();
      break;

    case 'continue':
      nextRound();
      break;
  }
}

// ==================== DRAFT ====================
function setupDraft() {
  G.draftPool = shuffle([...ALL_JOKERS]).slice(0, 10).map(j => ({...j, takenBy: -1}));
  G.draftRound = 0;
  G.currentDrafter = 0;
}

function renderDraft() {
  const drafter = G.currentDrafter;
  const isMyTurn = !isOnline() || drafter === myIdx;

  Q('dTurn').textContent = isMyTurn
    ? '×ª×•×¨ ×©×œ: ' + G.players[drafter].name
    : '×××ª×™×Ÿ ×œ-' + G.players[drafter].name + '...';

  // Pool
  const pool = Q('dPool');
  pool.innerHTML = '';
  for (let j of G.draftPool) {
    const taken = j.takenBy >= 0;
    const div = document.createElement('div');
    const rCls = {common:'c',rare:'r',legendary:'l',element:'e'}[j.r];
    const rLbl = {common:'× ×¤×•×¥',rare:'× ×“×™×¨',legendary:'××’×“×™',element:'××œ×× ×˜'}[j.r];
    div.className = 'jc' + (taken ? ' TK' : '') + (draftSel === j.id ? ' SL' : '');
    div.innerHTML = `<div class="jr ${rCls}">${rLbl}</div><div class="ji">${j.ic}</div><div class="jn">${j.n}</div><div class="jd">${j.d}</div>`;
    if (!taken && isMyTurn) div.onclick = () => { draftSel = j.id; renderDraft(); };
    pool.appendChild(div);
  }

  // Picks
  const picks = Q('dPicks');
  picks.innerHTML = '';
  const pIdx = isOnline() ? myIdx : drafter;
  for (let i = 0; i < 3; i++) {
    const sl = document.createElement('div');
    sl.className = 'dsl' + (G.players[pIdx].jokers[i] ? ' F' : '');
    sl.textContent = G.players[pIdx].jokers[i] ? G.players[pIdx].jokers[i].ic : (i + 1);
    picks.appendChild(sl);
  }

  Q('btnDraft').disabled = !draftSel || !isMyTurn;
  Q('btnDraft').classList.toggle('H', !isMyTurn);
}

function confirmDraft() {
  if (!draftSel) return;
  const pi = G.currentDrafter;
  if (isOnline()) send({type: 'draftPick', jokerId: draftSel, by: pi});
  applyDraftPick(draftSel, pi);
  draftSel = null;
}

function applyDraftPick(jId, pi) {
  const j = G.draftPool.find(x => x.id === jId);
  if (!j || j.takenBy >= 0) return;
  j.takenBy = pi;
  G.players[pi].jokers.push({...j});
  draftSel = null;
  G.draftRound++;

  if (G.draftRound >= 6) {
    startBattle();
    return;
  }

  const order = [0, 1, 1, 0, 0, 1];
  G.currentDrafter = order[G.draftRound];

  if (isOnline()) {
    renderDraft();
  } else {
    showHotSeat(G.currentDrafter, '×‘×—×¨ ×’\'×•×§×¨', () => renderDraft());
  }
}

// ==================== HOT SEAT ====================
function showHotSeat(pi, hint, cb) {
  if (isOnline()) { if (cb) cb(); return; }
  Q('hsName').textContent = G.players[pi].name;
  Q('hsName').style.color = pi === 0 ? 'var(--crim)' : 'var(--sky)';
  Q('hsHint').textContent = hint || '×”×¢×‘×™×¨×• ××ª ×”××›×©×™×¨';
  Q('hotSeat').classList.add('A');
  hsCb = cb;
}

function doReveal() {
  Q('hotSeat').classList.remove('A');
  if (hsCb) { hsCb(); hsCb = null; }
}

// ==================== BATTLE START ====================
function startBattle() {
  G.round = 0;
  G.turnPlayer = 0;
  G.picks = [null, null];

  // Apply start jokers
  for (let i = 0; i < 2; i++) {
    const p = G.players[i], o = G.players[1 - i];
    if (hasJoker(i, '×¡×•×—×¨') && o.hand.length && p.hand.length) {
      const a = Math.floor(Math.random() * p.hand.length);
      const b = Math.floor(Math.random() * o.hand.length);
      [p.hand[a], o.hand[b]] = [o.hand[b], p.hand[a]];
    }
    if (hasJoker(i, '×¦×œ') && o.jokers.length) {
      const cp = {...o.jokers[Math.floor(Math.random() * o.jokers.length)]};
      cp.id += 100; cp.n += ' (×¦×œ)';
      p.jokers.push(cp);
    }
  }

  showScreen('game');
  if (isOnline()) { renderGame(); }
  else { showHotSeat(0, '×‘×—×¨ ×§×œ×£ ×œ×§×¨×‘!', () => renderGame()); }
}

function hasJoker(pi, name) { return G.players[pi].jokers.some(j => j.n.startsWith(name)); }
function getJoker(pi, name) { return G.players[pi].jokers.find(j => j.n.startsWith(name)); }
function jMult(pi, name) { return hasJoker(pi, name) ? (hasJoker(pi, '××™× ×¤×™× ×™×˜×™') ? 2 : 1) : 0; }

// ==================== RENDER GAME ====================
function renderGame() {
  const viewAs = isOnline() ? myIdx : G.turnPlayer;
  const p = G.players[viewAs];
  const opp = G.players[1 - viewAs];

  Q('gn1').textContent = G.players[0].name;
  Q('gn2').textContent = G.players[1].name;
  Q('gw1').textContent = G.players[0].wins + ' âœ“';
  Q('gw2').textContent = G.players[1].wins + ' âœ“';
  Q('gRound').textContent = `×¡×™×‘×•×‘ ${G.round + 1} | ×—×¤×™×¡×”: ${G.deck.length}`;
  Q('slbl1').textContent = G.players[0].name;
  Q('slbl2').textContent = G.players[1].name;

  // Jokers bar
  const jbar = Q('jBar');
  jbar.innerHTML = '';
  for (let j of p.jokers) {
    const d = document.createElement('div');
    d.className = 'mj' + (j.used ? ' U' : '');
    d.innerHTML = `<span>${j.ic}</span><span>${j.n}</span>`;
    jbar.appendChild(d);
  }

  // Battle slots
  for (let i = 0; i < 2; i++) {
    const slot = Q(i === 0 ? 'slot1' : 'slot2');
    if (G.picks[i]) {
      slot.className = 'bslot F';
      slot.innerHTML = '<div class="cback"></div><span class="lb">' + G.players[i].name + '</span>';
    } else {
      slot.className = 'bslot';
      slot.innerHTML = '<span style="color:var(--t3)">?</span><span class="lb">' + G.players[i].name + '</span>';
    }
  }

  // Spy joker
  if (hasJoker(viewAs, '××¨×’×œ') && opp.hand.length && !G.spySeen) {
    G.spySeen = true;
    Q('spyTxt').textContent = '×§×œ×£ ×©×œ ' + opp.name + ':';
    Q('spyCards').innerHTML = '';
    Q('spyCards').appendChild(buildCardEl(opp.hand[0], -1));
    Q('spyOv').classList.add('A');
  }

  // Chaos joker - swap 2 card values
  if (hasJoker(viewAs, '×›××•×¡') && p.hand.length >= 2) {
    const normals = p.hand.filter(c => c.type === 'normal');
    if (normals.length >= 2) {
      const i1 = Math.floor(Math.random() * normals.length);
      let i2 = Math.floor(Math.random() * normals.length);
      while (i2 === i1) i2 = Math.floor(Math.random() * normals.length);
      [normals[i1].value, normals[i2].value] = [normals[i2].value, normals[i1].value];
    }
  }

  // Supreme power - lowest = 15
  p.hand.forEach(c => delete c._sup);
  if (hasJoker(viewAs, '×›×•×— ×¢×œ×™×•×Ÿ') && p.hand.length) {
    let minC = p.hand[0];
    for (let c of p.hand) if (c.value < minC.value) minC = c;
    minC._sup = 15;
  }

  // Render hand
  renderHand(p, viewAs);

  // Pair hint
  Q('pairHint').textContent = sel1 ? `× ×‘×—×¨ ${cardName(sel1)} â€” ×‘×—×¨ ×¢×•×“ ×§×œ×£ ××• ×œ×—×¥ ×œ×—×™××”` : '×‘×—×¨ ×§×œ×£ (××• ×©× ×™×™× ×¢× ××•×ª×• ××¡×¤×¨ ×œ×–×•×’)';

  Q('handLbl').textContent = '×”×™×“ ×©×œ ' + p.name;

  const canPlay = !isOnline() || !G.picks[myIdx];
  Q('btnPlay').disabled = !sel1 || !canPlay;
  Q('gacts').style.opacity = canPlay ? 1 : 0.4;
  Q('gacts').style.pointerEvents = canPlay ? 'auto' : 'none';

  if (isOnline() && G.picks[myIdx] && !G.picks[1 - myIdx]) {
    announce('×××ª×™×Ÿ ×œ×™×¨×™×‘...');
  }
}

function cardName(card) {
  if (card.type === 'element') return ELEM_IC[card.elem] + ' ' + ELEM_HEB[card.elem];
  return FACE_NAME[card.value] || card.value;
}

function renderHand(player, pi) {
  const area = Q('handArea');
  area.innerHTML = '';

  const sorted = [...player.hand].sort((a, b) => {
    if (a.type !== b.type) return a.type === 'element' ? 1 : -1;
    return a.value - b.value;
  });

  for (let card of sorted) {
    const el = buildCardEl(card, pi);
    const isSel1 = sel1 && sel1.id === card.id;
    const isSel2 = sel2 && sel2.id === card.id;
    if (isSel1) el.classList.add('SEL');
    if (isSel2) el.classList.add('SEL2');

    el.onclick = () => selectCard(card, pi);
    area.appendChild(el);
  }
}

function buildCardEl(card, ownerPi) {
  const div = document.createElement('div');
  if (card.type === 'normal') {
    div.className = 'card ' + SUIT_CLS[card.suit];
    const dv = card._sup ? 'â˜…' : (FACE_NAME[card.value] || card.value);
    const si = SUIT_ICON[card.suit];
    div.innerHTML = `<div class="csT">${si}</div><div class="cval">${dv}</div><div class="csB">${si}</div>`;
    if (ownerPi >= 0) {
      const b = calcBonus(card, ownerPi);
      if (b > 0) div.innerHTML += `<div class="cbon">+${b}</div>`;
    }
  } else {
    div.className = 'card ' + ELEM_CLS[card.elem];
    div.innerHTML = `<div class="cval">${ELEM_IC[card.elem]}</div><div class="clbl">${ELEM_HEB[card.elem]}</div>`;
    if (ownerPi >= 0) {
      const b = calcBonus(card, ownerPi);
      if (b > 0) div.innerHTML += `<div class="cbon">+${b}</div>`;
    }
  }
  return div;
}

function calcBonus(card, pi) {
  if (pi < 0) return 0;
  let b = 0;
  const p = G.players[pi], o = G.players[1 - pi];
  const v = card._sup || card.value;
  const m = n => jMult(pi, n);

  if (card.type === 'normal') {
    if (v >= 1 && v <= 4) b += 3 * m('×©×¨×™×•×Ÿ');
    if (v >= 11 && v <= 13) b += 2 * m('×›×ª×¨');
    if (v % 2 === 0) b += 2 * m('×–×•×’×™');
    if (v % 2 !== 0) b += 2 * m('××™-×–×•×’×™');
    if (v >= 10) b += 1 * m('×‘×•×œ×“×•×–×¨');
    if (card.suit === 'heart') b += 3 * m('××’× ×˜');
    if (card.suit === 'spade') b += 3 * m('×‘×¨×–×œ');
    if (card.suit === 'diamond') b += 3 * m('××•×¨');
    if (card.suit === 'club') b += 3 * m('×ª×œ×ª×Ÿ');
    if (v === 1 && hasJoker(pi, '××¡ ×‘×©×¨×•×•×œ')) b += 13;
    if (hasJoker(pi, '×©×¢×•×Ÿ ×—×•×œ') && p.hand.length === o.hand.length) b += 1 * m('×©×¢×•×Ÿ ×—×•×œ');
  }
  if (card.type === 'element' && hasJoker(pi, '×©×œ×™×˜×ª ×™×¡×•×“×•×ª')) b += 3;
  if (p.lastLost) { b += 2 * m('×¦×‘'); b += 4 * m('× ×§××”'); }
  if (p.streak >= 2 && hasJoker(pi, '×¨×¦×£')) b += (p.streak - 1) * m('×¨×¦×£');
  if (p.firstPlay) b += 5 * m('××”×™×¨');
  if (card._sup) b = 0;
  return b;
}

// ==================== CARD SELECTION ====================
function selectCard(card, pi) {
  // If this card is already sel1, deselect it
  if (sel1 && sel1.id === card.id) {
    sel1 = sel2; sel2 = null;
    renderGame();
    return;
  }
  // If this card is already sel2, deselect it
  if (sel2 && sel2.id === card.id) {
    sel2 = null;
    renderGame();
    return;
  }

  if (!sel1) {
    // First pick
    sel1 = card;
  } else if (!sel2) {
    // Second pick â€” only if same value (pair) and both normal
    if (sel1.type === 'normal' && card.type === 'normal' && sel1.value === card.value && sel1.id !== card.id) {
      sel2 = card;
    } else {
      // Replace first selection
      sel1 = card;
      sel2 = null;
    }
  } else {
    // Already have pair â€” start over
    sel1 = card;
    sel2 = null;
  }

  renderGame();
}

// ==================== PLAY ====================
function confirmPlay() {
  if (!sel1) return;
  const viewAs = isOnline() ? myIdx : G.turnPlayer;

  // Ace choice needed?
  if (!sel2 && sel1.type === 'normal' && sel1.value === 1 && !hasJoker(viewAs, '××¡ ×‘×©×¨×•×•×œ')) {
    Q('aceModal').classList.add('A');
    return;
  }

  finalizePick();
}

function pickAce(v) {
  Q('aceModal').classList.remove('A');
  sel1._aceValue = v;
  finalizePick();
}

function finalizePick() {
  const viewAs = isOnline() ? myIdx : G.turnPlayer;
  const p = G.players[viewAs];

  let pick;
  if (sel2) {
    pick = {isPair: true, c1: {...sel1}, c2: {...sel2}};
    p.hand = p.hand.filter(c => c.id !== sel1.id && c.id !== sel2.id);
  } else {
    pick = {...sel1};
    p.hand = p.hand.filter(c => c.id !== sel1.id);
  }

  G.picks[viewAs] = pick;
  sel1 = null; sel2 = null;

  if (isOnline()) {
    send({type: 'cardPick', pick: pick, by: myIdx});
    if (G.picks[0] && G.picks[1]) resolveBattle();
    else renderGame();
  } else {
    // Local hot seat
    if (G.turnPlayer === 0) {
      G.turnPlayer = 1;
      G.spySeen = false;
      showHotSeat(1, '×‘×—×¨ ×§×œ×£ ×œ×§×¨×‘!', () => renderGame());
    } else {
      resolveBattle();
    }
  }
}

// ==================== RESOLVE ====================
function resolveBattle() {
  const c1 = G.picks[0], c2 = G.picks[1];
  let v1 = calcFinal(c1, 0), v2 = calcFinal(c2, 1);
  let detail = '';

  // Element vs Element
  let eff1 = null, eff2 = null;
  const e1 = getElem(c1), e2 = getElem(c2);
  if (e1 && e2) {
    if (ELEM_BEATS[e1] === e2) { v1 = 12; v2 = 2; eff1 = e1; }
    else if (ELEM_BEATS[e2] === e1) { v2 = 12; v1 = 2; eff2 = e2; }
  }

  // Mirror joker
  for (let pi of [0, 1]) {
    const mj = getJoker(pi, '××¨××”');
    if (mj && !mj.used) {
      const my = pi === 0 ? v1 : v2, op = pi === 0 ? v2 : v1;
      if (my < op) { mj.used = true; if (pi === 0) v1 = op + 1; else v2 = op + 1; detail += ' ğŸª ××¨××”!'; }
    }
  }

  // Balance (tie-win)
  let winner = -1;
  if (v1 === v2) {
    if (hasJoker(0, '×××–× ×™×™×') && !hasJoker(1, '×××–× ×™×™×')) winner = 0;
    else if (hasJoker(1, '×××–× ×™×™×') && !hasJoker(0, '×××–× ×™×™×')) winner = 1;
  }

  let resTxt;
  if (winner >= 0) {
    resTxt = `âš–ï¸ ${G.players[winner].name} ×× ×¦×— ×‘×ª×™×§×•!`;
  } else if (v1 > v2) { winner = 0; resTxt = `ğŸ‰ ${G.players[0].name} ×× ×¦×—!`; }
  else if (v2 > v1) { winner = 1; resTxt = `ğŸ‰ ${G.players[1].name} ×× ×¦×—!`; }
  else { resTxt = 'ğŸ¤ ×ª×™×§×•!'; }

  // Flip joker
  if (winner >= 0) {
    const loser = 1 - winner;
    const fj = getJoker(loser, '××”×¤×š');
    if (fj && !fj.used) { fj.used = true; winner = loser; resTxt = `ğŸ”„ ××”×¤×š! ${G.players[winner].name}!`; detail += ' ××”×¤×š!'; }
  }

  // Wall
  if (winner >= 0 && hasJoker(1 - winner, '×—×•××”') && Math.random() < 0.5) {
    detail += ' ğŸ§± ×—×•××”!'; winner = -1;
  }

  // Apply winner effects
  if (winner >= 0) {
    G.players[winner].wins++;
    G.players[winner].streak++;
    G.players[winner].lastLost = false;
    G.players[1 - winner].streak = 0;
    G.players[1 - winner].lastLost = true;

    // Thief
    if (hasJoker(winner, '×’× ×‘')) {
      const o = G.players[1 - winner];
      if (o.hand.length) { G.players[winner].hand.push(o.hand.splice(Math.floor(Math.random() * o.hand.length), 1)[0]); detail += ' ğŸ¤ ×’× ×‘!'; }
    }
    // Bulldozer
    if (hasJoker(winner, '×‘×•×œ×“×•×–×¨') && Math.abs(v1 - v2) >= 5) {
      const o = G.players[1 - winner];
      if (o.hand.length) { o.hand.splice(Math.floor(Math.random() * o.hand.length), 1); detail += ' ğŸšœ ×‘×•×œ×“×•×–×¨!'; }
    }
    // Element effects
    const winElem = winner === 0 ? eff1 : eff2;
    if (winElem) {
      const loserP = G.players[1 - winner], winnerP = G.players[winner];
      const dbl = hasJoker(winner, '×©×œ×™×˜×ª ×™×¡×•×“×•×ª');
      if (winElem === 'fire') { const t = dbl ? 2 : 1; for (let i = 0; i < t; i++) if (loserP.hand.length) loserP.hand.splice(Math.floor(Math.random() * loserP.hand.length), 1); detail += ' ğŸ”¥ ××©!'; }
      if (winElem === 'water') { const t = dbl ? 2 : 1; for (let i = 0; i < t; i++) if (G.deck.length) winnerP.hand.push(G.deck.pop()); detail += ' ğŸ’§ ××™×!'; }
      if (winElem === 'ice') { loserP.blind = true; detail += ' â„ï¸ ×§×¨×—!'; }
      if (winElem === 'wind' && loserP.hand.length) { loserP.hand.splice(Math.floor(Math.random() * loserP.hand.length), 1); if (G.deck.length) loserP.hand.push(G.deck.pop()); detail += ' ğŸŒªï¸ ×¨×•×—!'; }
    }
    // Storm
    const selW = winner === 0 ? c1 : c2;
    if (getElem(selW) && hasJoker(winner, '×¡×•×¤×”') && G.deck.length) { G.players[winner].hand.push(G.deck.pop()); detail += ' ğŸŒŠ ×¡×•×¤×”!'; }
  } else {
    G.players[0].lastLost = false;
    G.players[1].lastLost = false;
  }

  G.players[0].firstPlay = false;
  G.players[1].firstPlay = false;

  // Phoenix
  for (let pi of [0, 1]) {
    const ph = getJoker(pi, '×¤× ×™×§×¡');
    if (ph && !ph.used && G.players[pi].hand.length <= 2) {
      ph.used = true;
      for (let i = 0; i < 3; i++) if (G.deck.length) G.players[pi].hand.push(G.deck.pop());
      detail += ` ğŸ¦ ×¤× ×™×§×¡ ${G.players[pi].name}!`;
    }
  }

  // *** CRITICAL: Refill hands to 5 ***
  for (let pi of [0, 1]) {
    while (G.players[pi].hand.length < 5 && G.deck.length > 0) {
      G.players[pi].hand.push(G.deck.pop());
    }
  }

  showResult(c1, c2, v1, v2, resTxt, detail);
}

function getElem(s) { if (!s || s.isPair) return null; return s.type === 'element' ? s.elem : null; }

function calcFinal(s, pi) {
  if (!s) return 0;
  if (s.isPair) return (s.c1.value + calcBonus(s.c1, pi)) + (s.c2.value + calcBonus(s.c2, pi));
  let base = s._sup || s._aceValue || s.value;
  if (s.type === 'normal' && s.value === 1 && hasJoker(pi, '××¡ ×‘×©×¨×•×•×œ')) base = 14;
  return base + calcBonus(s, pi);
}

function showResult(c1, c2, v1, v2, txt, detail) {
  Q('resTxt').textContent = txt;
  Q('resDetail').textContent = detail;
  const area = Q('resCards');
  area.innerHTML = '';

  const w1 = document.createElement('div'); w1.className = 'ovWrap';
  w1.innerHTML = `<div class="wn">${G.players[0].name}</div>`;
  if (c1.isPair) { const d = document.createElement('div'); d.style.cssText = 'display:flex;gap:5px'; d.appendChild(buildCardEl(c1.c1, 0)); d.appendChild(buildCardEl(c1.c2, 0)); w1.appendChild(d); }
  else w1.appendChild(buildCardEl(c1, 0));
  w1.innerHTML += `<div class="wv">×¢×¨×š: ${v1}</div>`;

  const vs = document.createElement('div'); vs.className = 'ovVs'; vs.textContent = 'VS';

  const w2 = document.createElement('div'); w2.className = 'ovWrap';
  w2.innerHTML = `<div class="wn">${G.players[1].name}</div>`;
  if (c2.isPair) { const d = document.createElement('div'); d.style.cssText = 'display:flex;gap:5px'; d.appendChild(buildCardEl(c2.c1, 1)); d.appendChild(buildCardEl(c2.c2, 1)); w2.appendChild(d); }
  else w2.appendChild(buildCardEl(c2, 1));
  w2.innerHTML += `<div class="wv">×¢×¨×š: ${v2}</div>`;

  area.appendChild(w1); area.appendChild(vs); area.appendChild(w2);
  Q('resultOv').classList.add('A');
}

function afterResult() {
  Q('resultOv').classList.remove('A');
  if (isOnline()) send({type: 'continue'});
  nextRound();
}

function nextRound() {
  G.picks = [null, null];
  G.round++;
  sel1 = null; sel2 = null;

  // Clear supremes
  for (let p of G.players) p.hand.forEach(c => { delete c._sup; delete c._aceValue; });
  for (let p of G.players) p.blind = false;

  // Check game over
  const totalCards = G.players[0].hand.length + G.players[1].hand.length + G.deck.length;
  if (totalCards === 0 || (G.players[0].hand.length === 0 && G.players[1].hand.length === 0)) {
    endGame();
    return;
  }

  G.turnPlayer = 0;
  G.spySeen = false;

  if (isOnline()) renderGame();
  else showHotSeat(0, '×‘×—×¨ ×§×œ×£ ×œ×§×¨×‘!', () => renderGame());
}

// ==================== GAME OVER ====================
function endGame() {
  const w1 = G.players[0].wins, w2 = G.players[1].wins;
  Q('goWin').textContent = w1 > w2 ? `ğŸ‰ ${G.players[0].name} ×× ×¦×—!` : w2 > w1 ? `ğŸ‰ ${G.players[1].name} ×× ×¦×—!` : 'ğŸ¤ ×ª×™×§×•!';
  Q('goWin').style.color = w1 > w2 ? 'var(--crim)' : w2 > w1 ? 'var(--sky)' : 'var(--gold)';
  Q('goScore').textContent = `${G.players[0].name}: ${w1} | ${G.players[1].name}: ${w2}`;
  showScreen('gover');

  // Confetti
  const cf = Q('confetti'); cf.innerHTML = '';
  const cols = ['#DC2626','#F59E0B','#10B981','#0EA5E9','#8B5CF6','#EC4899'];
  for (let i = 0; i < 50; i++) {
    const p = document.createElement('div'); p.className = 'cfp';
    p.style.left = Math.random() * 100 + '%';
    p.style.background = cols[Math.floor(Math.random() * cols.length)];
    p.style.width = (5 + Math.random() * 10) + 'px';
    p.style.height = (5 + Math.random() * 10) + 'px';
    p.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    p.style.animationDuration = (2 + Math.random() * 3) + 's';
    p.style.animationDelay = Math.random() * 2 + 's';
    cf.appendChild(p);
  }
}

function backToMenu() {
  showScreen('menu');
  if (peer) { peer.destroy(); peer = null; }
  conn = null; myIdx = -1;
  sel1 = null; sel2 = null;
}

// ==================== UTILS ====================
function announce(txt) {
  const el = Q('ann'); el.textContent = txt;
  el.className = 'ann'; void el.offsetWidth;
  el.className = 'ann SH';
  setTimeout(() => el.className = 'ann H', 2200);
}

function toggleRules() { Q('rulesM').classList.toggle('A'); }
</script>
</body>
</html>
